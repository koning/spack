name: sync with spack/spack-packages

on:
  push:
    branches:
    - develop

jobs:
  sync:
    if: github.repository == 'spack/spack'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout spack/spack
      run: git clone https://github.com/spack/spack.git
    - name: Checkout spack/spack-packages
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      with:
        ssh-key: ${{ secrets.SYNC_PACKAGES_KEY }}
        path: spack-packages
        repository: spack/spack-packages
    - name: Install git-filter-repo
      run: |
        curl -LfsO https://raw.githubusercontent.com/newren/git-filter-repo/refs/tags/v2.47.0/git-filter-repo
        echo "67447413e273fc76809289111748870b6f6072f08b17efe94863a92d810b7d94  git-filter-repo" | sha256sum -c -
        chmod +x git-filter-repo
        sudo mv git-filter-repo /usr/local/bin/
    - name: Sync spack/spack-packages with spack/spack
      run: |
        cd spack-packages
        git-filter-repo --quiet --source ../spack \
                        --path .github/CODE_OF_CONDUCT.md --path-rename .github/CODE_OF_CONDUCT.md:.github/CODE_OF_CONDUCT.md \
                        --path .github/CONTRIBUTING.md --path-rename .github/CONTRIBUTING.md:.github/CONTRIBUTING.md \
                        --path .github/ISSUE_TEMPLATE/ \
                        --path .github/pull_request_template.md \
                        --path .github/workflows/audit.yaml \
                        --path .github/workflows/ci.yaml \
                        --path .github/workflows/prechecks.yml \
                        --path .github/workflows/unit_tests.yaml \
                        --path lib/spack/spack/test/__init__.py --path-rename lib/spack/spack/test/__init__.py:tests/__init__.py \
                        --path lib/spack/spack/test/build_systems.py --path-rename lib/spack/spack/test/build_systems.py:tests/build_systems.py \
                        --path lib/spack/spack/test/conftest.py --path-rename lib/spack/spack/test/conftest.py:tests/conftest.py \
                        --path lib/spack/spack/test/data/make --path-rename lib/spack/spack/test/data/make:tests/data/make \
                        --path lib/spack/spack/test/data/ninja --path-rename lib/spack/spack/test/data/ninja:tests/data/ninja \
                        --path pytest.ini \
                        --path share/spack/gitlab/cloud_pipelines/ --path-rename share/spack/gitlab/cloud_pipelines/:.ci/gitlab/ \
                        --path share/spack/qa/validate_last_exit.ps1 --path-rename share/spack/qa/validate_last_exit.ps1:.ci/validate_last_exit.ps1 \
                        --path share/spack/qa/windows_test_setup.ps1 --path-rename share/spack/qa/windows_test_setup.ps1:.ci/windows_test_setup.ps1 \
                        --path var/spack/repos/ --path-rename var/spack/repos/:repos/ \
                        --path var/spack/repos/README.md --path-rename var/spack/repos/README.md:README.md \
                        --path var/spack/spack-repo-index.yaml --path-rename var/spack/spack-repo-index.yaml:spack-repo-index.yaml \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/autotools_conditional_variants_test/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/autotools_conditional_variants_test/package.py:tests/repos/spack_repo/builtin_mock/packages/autotools_conditional_variants_test/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/autotools_config_replacement/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/autotools_config_replacement/package.py:tests/repos/spack_repo/builtin_mock/packages/autotools_config_replacement/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/cmake_client/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/cmake_client/package.py:tests/repos/spack_repo/builtin_mock/packages/cmake_client/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/cmake_conditional_variants_test/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/cmake_conditional_variants_test/package.py:tests/repos/spack_repo/builtin_mock/packages/cmake_conditional_variants_test/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/compiler_wrapper/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/compiler_wrapper/package.py:tests/repos/spack_repo/builtin_mock/packages/compiler_wrapper/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/dtbuild1/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/dtbuild1/package.py:tests/repos/spack_repo/builtin_mock/packages/dtbuild1/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/dtbuild2/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/dtbuild2/package.py:tests/repos/spack_repo/builtin_mock/packages/dtbuild2/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/dtbuild3/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/dtbuild3/package.py:tests/repos/spack_repo/builtin_mock/packages/dtbuild3/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/dtlink1/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/dtlink1/package.py:tests/repos/spack_repo/builtin_mock/packages/dtlink1/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/dtlink2/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/dtlink2/package.py:tests/repos/spack_repo/builtin_mock/packages/dtlink2/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/dtlink3/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/dtlink3/package.py:tests/repos/spack_repo/builtin_mock/packages/dtlink3/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/dtlink4/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/dtlink4/package.py:tests/repos/spack_repo/builtin_mock/packages/dtlink4/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/dtlink5/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/dtlink5/package.py:tests/repos/spack_repo/builtin_mock/packages/dtlink5/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/dtrun1/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/dtrun1/package.py:tests/repos/spack_repo/builtin_mock/packages/dtrun1/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/dtrun2/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/dtrun2/package.py:tests/repos/spack_repo/builtin_mock/packages/dtrun2/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/dtrun3/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/dtrun3/package.py:tests/repos/spack_repo/builtin_mock/packages/dtrun3/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/dttop/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/dttop/package.py:tests/repos/spack_repo/builtin_mock/packages/dttop/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/gcc/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/gcc/package.py:tests/repos/spack_repo/builtin_mock/packages/gcc/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/gcc_runtime/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/gcc_runtime/package.py:tests/repos/spack_repo/builtin_mock/packages/gcc_runtime/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/glibc/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/glibc/package.py:tests/repos/spack_repo/builtin_mock/packages/glibc/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/gmake/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/gmake/package.py:tests/repos/spack_repo/builtin_mock/packages/gmake/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/libtool_deletion/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/libtool_deletion/package.py:tests/repos/spack_repo/builtin_mock/packages/libtool_deletion/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_gnu/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_gnu/package.py:tests/repos/spack_repo/builtin_mock/packages/mirror_gnu/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_gnu_broken/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_gnu_broken/package.py:tests/repos/spack_repo/builtin_mock/packages/mirror_gnu_broken/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_sourceforge/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_sourceforge/package.py:tests/repos/spack_repo/builtin_mock/packages/mirror_sourceforge/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_sourceforge_broken/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_sourceforge_broken/package.py:tests/repos/spack_repo/builtin_mock/packages/mirror_sourceforge_broken/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_sourceware/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_sourceware/package.py:tests/repos/spack_repo/builtin_mock/packages/mirror_sourceware/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_sourceware_broken/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_sourceware_broken/package.py:tests/repos/spack_repo/builtin_mock/packages/mirror_sourceware_broken/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_xorg/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_xorg/package.py:tests/repos/spack_repo/builtin_mock/packages/mirror_xorg/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_xorg_broken/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/mirror_xorg_broken/package.py:tests/repos/spack_repo/builtin_mock/packages/mirror_xorg_broken/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/mpich/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/mpich/package.py:tests/repos/spack_repo/builtin_mock/packages/mpich/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/pkg_a/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/pkg_a/package.py:tests/repos/spack_repo/builtin_mock/packages/pkg_a/package.py \
                        --path var/spack/test_repos/spack_repo/builtin_mock/packages/pkg_b/package.py --path-rename var/spack/test_repos/spack_repo/builtin_mock/packages/pkg_b/package.py:tests/repos/spack_repo/builtin_mock/packages/pkg_b/package.py \
                        --refs develop
    - name: Push
      run: |
        cd spack-packages
        git push git@github.com:spack/spack-packages.git develop:develop --force
